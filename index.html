<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CSV Uploader</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <style>
      /* Ensures the label and input stack properly inside the form-group */
      .form-group {
        display: flex;
        flex-direction: column;
      }

      /* Basic styling for the file input itself (browser defaults are hard to style) */
      input[type="file"] {
        padding: 8px 0;
      }

      /* Custom style for the response area border */
      .response-box {
        border-left: 5px solid theme("colors.gray.300"); /* Subtle left border */
        transition: border-color 0.3s;
      }

      /* Success styling */
      .response-success {
        border-color: theme("colors.green.500") !important;
        background-color: theme("colors.green.50"); /* Light green background */
      }

      /* Error styling */
      .response-error {
        border-color: theme("colors.red.500") !important;
        background-color: theme("colors.red.50"); /* Light red background */
      }

      /* Loading/Info styling */
      .response-info {
        background-color: theme(
          "colors.blue.50"
        ); /* Light blue for processing */
        border-color: theme("colors.blue.500");
      }
    </style>
  </head>
  <body class="bg-gray-100 p-8">
    <div class="container bg-white p-8 rounded-lg shadow-xl mx-auto max-w-2xl">
      <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">
        Upload Bank CSV to Google Sheets
      </h1>

      <form
        id="uploadForm"
        enctype="multipart/form-data"
        class="grid grid-cols-2 gap-x-6 gap-y-4"
      >
        <div class="form-group">
          <label
            for="spreadsheet_id"
            class="text-sm font-medium text-gray-600 mb-1"
            >Spreadsheet ID:</label
          >
          <input
            type="text"
            id="spreadsheet_id"
            name="spreadsheet_id"
            required
            class="border border-gray-300 p-2 rounded-md focus:ring-blue-500 focus:border-blue-500"
          />
        </div>

        <div class="form-group">
          <label for="keyword" class="text-sm font-medium text-gray-600 mb-1"
            >Keyword (e.g., 'Dec' for month):</label
          >
          <input
            type="text"
            id="keyword"
            name="keyword"
            required
            class="border border-gray-300 p-2 rounded-md focus:ring-blue-500 focus:border-blue-500"
          />
        </div>

        <div class="form-group">
          <label for="bankname" class="text-sm font-medium text-gray-600 mb-1"
            >Bank Name:</label
          >
          <select
            id="bankname"
            name="bankname"
            required
            class="border border-gray-300 p-2 rounded-md focus:ring-blue-500 focus:border-blue-500"
          >
            <option value="tangerine">Tangerine</option>
            <option value="cibc">CIBC</option>
          </select>
        </div>

        <div class="form-group">
          <label for="usertype" class="text-sm font-medium text-gray-600 mb-1"
            >User Type:</label
          >
          <select
            id="usertype"
            name="usertype"
            required
            class="border border-gray-300 p-2 rounded-md focus:ring-blue-500 focus:border-blue-500"
          >
            <option value="1">User 1</option>
            <option value="2">User 2</option>
          </select>
        </div>

        <div class="form-group col-span-2">
          <label for="csv_file" class="text-sm font-medium text-gray-600 mb-1"
            >CSV File:</label
          >
          <input
            type="file"
            id="csv_file"
            name="csv_file"
            accept=".csv"
            required
            class="text-gray-600 border border-gray-300 p-2 rounded-md bg-gray-50 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
          />
        </div>

        <div class="col-span-2 flex justify-center mt-4">
          <button
            type="submit"
            class="upload-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition duration-150 shadow-md"
          >
            Upload
          </button>
        </div>
      </form>

      <div
        id="responseArea"
        class="server-response response-box hidden p-4 mt-8 rounded-lg border border-gray-300"
      >
        <h3 class="text-lg font-semibold text-gray-700 mb-2">
          Server Response:
        </h3>
        <p id="responseText" class="text-base text-gray-800 font-bold"></p>
      </div>
    </div>

    <script>
      document
        .getElementById("uploadForm")
        .addEventListener("submit", async function (event) {
          event.preventDefault();

          const formData = new FormData(this);
          const responseArea = document.getElementById("responseArea");
          const responseText = document.getElementById("responseText");

          // --- Set Loading/Info State ---
          responseArea.classList.remove(
            "hidden",
            "response-success",
            "response-error"
          );
          responseArea.classList.add("response-info");
          responseText.textContent = "Processing upload... please wait.";

          try {
            const response = await fetch("/upload", {
              method: "POST",
              body: formData,
            });

            const contentType = response.headers.get("content-type");
            let result;

            if (contentType && contentType.includes("application/json")) {
              result = await response.json();
            } else {
              // Fallback for non-JSON response from server
              result = {
                message:
                  (await response.text()) ||
                  "An unknown server response was received.",
              };
            }

            // --- ðŸ’¡ KEY CHANGE: Use result.message directly ---
            responseText.textContent =
              result.message ||
              "Operation complete (No specific message provided).";

            if (response.ok) {
              // SUCCESS
              responseArea.classList.remove("response-error", "response-info");
              responseArea.classList.add("response-success");
            } else {
              // ERROR (HTTP Status 4xx or 5xx)
              responseArea.classList.remove(
                "response-success",
                "response-info"
              );
              responseArea.classList.add("response-error");
            }
            // --- END KEY CHANGE ---
          } catch (error) {
            // Network or parsing error
            responseText.textContent =
              "A critical network error occurred: " + error.message;
            responseArea.classList.remove("response-success", "response-info");
            responseArea.classList.add("response-error");
          }
        });
    </script>
  </body>
</html>